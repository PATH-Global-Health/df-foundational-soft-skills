{
  "hash": "83ed5d77a00ea11cb8645ebee7c179ff",
  "result": {
    "markdown": "---\ntitle: \"Tutorial - How to turn a bad slide into a good slide\"\n---\n\n::: {.cell}\n\n:::\n\n\n\nThis tutorial follows on from the How to turn a bad slide into a good slide section of the powerpoint presentation. It will walk through the code used to generate the plots and includes some follow on exercises for you to complete with this same dataset.\n\n## Libraries and Data Preparation\n\nFirst lets load in the necessary R packages and the dataset for this tutorial - which you can download from the [box folder](https://path.box.com/s/hyieea6hd05ay2xli1hmiz5jinn2h7l6).\n\n::: callout-tip\nMake sure you save the data in the same folder as your associated R Project for this module.\n\nIf you haven't already installed the necessary R packages for this tutorial you will need to call the install.packages before loading the library.\n\nFor help installing `PATHtoolsZambia` see the [package webpage](https://path-global-health.github.io/PATHtoolsZambia/) for more details.\n:::\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Load libraries\nlibrary(tidyverse)\nlibrary(PATHtoolsZambia)\nlibrary(scales)\nlibrary(sf)\nlibrary(ggpubr)\n\n# Load the data\ndat <- read.csv(\"monthly-cases.csv\")\n```\n:::\n\n\n### Data Preparation\n\nOur motivating question here is: **What is the malaria trend in Northern Province Zambia since 2018?**\n\nLets take a quick look at this dataset and see what kind of data we are working with. We have 5 columns `period` with monthly values from 2018 - June 2024, `reported_district` with names of all the districts in Northern Province, `data_type` shows our case data is in long format with values of clinical, confirmed and Confirmed_Passive_CHW, `age_group` again is in long format with categories of Under 5 and Over 5 and finally the `total` column that provides the number of cases reported.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# see column names\nhead(dat)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n      period reported_district data_type age_group total\n1 2018-01-01           Chilubi  Clinical   Under 5    14\n2 2018-01-01           Chilubi  Clinical    Over 5    30\n3 2018-01-01           Chilubi  Clinical   Under 5     6\n4 2018-01-01           Chilubi Confirmed   Under 5  1015\n5 2018-01-01           Chilubi Confirmed    Over 5  1657\n6 2018-01-01           Chilubi Confirmed   Under 5   372\n```\n:::\n\n```{.r .cell-code}\n# Display each column's unique values to explore data options\ndat %>% select(-total) %>% map(~ table(.))\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n$period\n.\n2018-01-01 2018-02-01 2018-03-01 2018-04-01 2018-05-01 2018-06-01 2018-07-01 \n        59         60         60         52         58         54         49 \n2018-08-01 2018-09-01 2018-10-01 2018-11-01 2018-12-01 2019-01-01 2019-02-01 \n        55         54         50         55         56         55         51 \n2019-03-01 2019-04-01 2019-05-01 2019-06-01 2019-07-01 2019-08-01 2019-09-01 \n        57         62         60         64         62         63         61 \n2019-10-01 2019-11-01 2019-12-01 2020-01-01 2020-02-01 2020-03-01 2020-04-01 \n        56         59         75         75         76         75         77 \n2020-05-01 2020-06-01 2020-07-01 2020-08-01 2020-09-01 2020-10-01 2020-11-01 \n        76         76         72         68         68         70         72 \n2020-12-01 2021-01-01 2021-02-01 2021-03-01 2021-04-01 2021-05-01 2021-06-01 \n        72         74         74         72         75         73         68 \n2021-07-01 2021-08-01 2021-09-01 2021-10-01 2021-11-01 2021-12-01 2022-01-01 \n        66         69         70         71         80         81         80 \n2022-02-01 2022-03-01 2022-04-01 2022-05-01 2022-06-01 2022-07-01 2022-08-01 \n        80         80         76         77         81         78         75 \n2022-09-01 2022-10-01 2022-11-01 2022-12-01 2023-01-01 2023-02-01 2023-03-01 \n        74         81         73         74         79         80         84 \n2023-04-01 2023-05-01 2023-06-01 2023-07-01 2023-08-01 2023-09-01 2023-10-01 \n        87         86         83         81         79         88         83 \n2023-11-01 2023-12-01 2024-01-01 2024-02-01 2024-03-01 2024-04-01 2024-05-01 \n        82         82         89         89         96         90         91 \n2024-06-01 \n        91 \n\n$reported_district\n.\n  Chilubi    Kaputa    Kasama     Lunte Lupososhi   Luwingu     Mbala Mporokoso \n      581       368       510       431       426       379       606       323 \n Mpulungu    Mungwi     Nsama     Senga \n      464       423       487       608 \n\n$data_type\n.\n             Clinical             Confirmed Confirmed_Passive_CHW \n                 1803                  2810                   993 \n\n$age_group\n.\n Over 5 Under 5 \n   1946    3327 \n```\n:::\n\n```{.r .cell-code}\n# correct date data from character string to date variables:  \ndat$period <- as.Date(dat$period)\n```\n:::\n\n\nThe next step is to aggregate this data up across all of the Districts in Northern Province as we are interested in the Province as a whole, we will also aggregate across `age_groups` so we have the total population level totals for each `data_type`.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Summarize data at the province-month level across all age groups\ndat_sum <- \n  dat %>% \n  group_by(period, data_type) %>% \n  summarise(total = sum(total, na.rm = TRUE)) %>% \n  ungroup() %>% \n  filter(data_type %in% c(\"Clinical\", \"Confirmed\", \"Confirmed_Passive_CHW\"))\n```\n:::\n\n\n## Initial Visualization\n\n### The Raw Plot\n\nLets create a simple `ggplot()` of this dataset. What do we notice? Malaria appears to be increasing in Northern Province over the period from 2018 - 2024.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Create an initial raw plot\nggplot(dat_sum, \n       aes(x = period, y = total, color = data_type, group=data_type)\n       ) + \n  geom_line()\n```\n\n::: {.cell-output-display}\n![](story-telling_files/figure-html/unnamed-chunk-5-1.png){width=4200}\n:::\n:::\n\n\nThis plot can show us that Malaria appears to be increasing in Northern Province over the period from 2018 - 2024. However, there are several problems with this plot:\n\n-   No plot title\n\n-   Thin lines that are hard to see\n\n-   Hard to see how all the data types add together to get a total malaria trend\n\n-   Boring use of color (and potential issues for red-green color blind people)\n\n-   Untidy legend (no proper title, underscores between words)\n\n-   Figure labels too small\n\n-   Timeseries are squashed\n\n-   Axes not informatively labeled\n\n-   Numbers don't have commas (i.e 60,000)\n\n### Aesthetic Improvements\n\nThe best approach to making improvements to plots is to iteratively make small changes to enahance each aspect of the plot. Such as the following steps:\n\nLets first remove the \"\\_\" from one of our `data_type` variables for better readability.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# where data_type value is \"Confirmed_Passive_CHW\" replace with \"Confirmed Passive CHW\" otherwise keep the current data_type value\ndat_sum <- \n  dat_sum %>% \n  mutate(nice_names = \n           ifelse(data_type == \"Confirmed_Passive_CHW\", \"Confirmed Passive CHW\", data_type) \n         )\n```\n:::\n\n\nThen we can make some additions to the `ggplot()` code to further enhance the plot - each is described in the code below:\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Create an improved plot\nggplot(dat_sum, \n       aes(x = period, y = total, fill = nice_names, group=nice_names) # use nice_names for each line colour\n       ) + \n  geom_area() + # replace lines with a shaded area plot\n  scale_y_continuous(labels = comma) + # add comma separators to the numbers on the yaxis \n  labs(x = \"Year\", y = \"Total malaria cases per month\") + # include informative axis labels \n  ggtitle(\"Monthly malaria cases in Northern Province, Zambia\", # include a plot title and subtitle that's informative \n          subtitle = \"Jan 2018 - June 2024\"\n          ) + \n  scale_fill_manual(\"Data type\", values = c(\"#758ECD\", \"#A5C4D4\", \"#7B6D8D\")) + # change the default colours https://coolors.co/ is a great source of nice colors \n  theme_bw() # use an inbuilt ggplot theme \n```\n\n::: {.cell-output-display}\n![](story-telling_files/figure-html/unnamed-chunk-7-1.png){width=4200}\n:::\n:::\n\n\nThis is a good step in the right direction but it is still difficult to see the number of clinical cases when stacked at the top and the colours we have chosen are also slighty hard to distinguish so lets address these two aspects:\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# use factoring to alter the order of data_type in the plot  \ndat_sum <- \n  dat_sum %>% \n  mutate(nice_names = factor(nice_names, levels = c(\"Confirmed\",\n                                                    \"Confirmed Passive CHW\",\n                                                    \"Clinical\")\n                             )\n         )\n\n# Plot this data with new colurs \nggplot(dat_sum, aes(x = period, y = total, fill = nice_names, group=nice_names)) + \n  geom_area() +\n  scale_y_continuous(labels = comma) +\n  scale_x_date(date_breaks = \"1 year\", date_labels = \"%Y\") +\n  labs(x = \"Year\", y = \"Total malaria cases per month\") +\n  ggtitle(\"Monthly malaria cases in Northern Province, Zambia\",\n          subtitle = \"Jan 2018 - June 2024\") +\n  scale_fill_manual(\"Data type\", values = c(\"#A5C4D4\",\"#758ECD\", \"#E3A27F\")) + #changes colour\n  theme_bw()\n```\n\n::: {.cell-output-display}\n![](story-telling_files/figure-html/unnamed-chunk-8-1.png){width=4200}\n:::\n:::\n\n\n### Scientific story telling issues\n\nAs noted in the slides, while this plot is a visual improvement on the first we need to also address how we interpret this plot and the potential missing pieces to answer our analysis question.\n\n-   Our initial description of the results: \"Malaria appears to be increasing in Northern Province over the period from 2018 - 2024\" isn't very informative and is a limited description of the results.\n\n-   Plot shows total malaria cases -- doesn't account for population growth\n\n-   Cant really tell the extent to which cases are increasing over time -- hard to aggregate visually over 12 months of data to assess annual trends\n\n**Is more context needed to starting thinking of solutions? Are these increases occurring over all districts in the province? Are increases greater in under 5s or over 5s? Has coverage of interventions decreased over time?**\n\n## Technical Enhancements\n\nTo start addressing some of these issues we can add in some additional context to this plot - through using population data we can add in an understanding of how malaria incidence as well as raw case counts are changing over time.\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Retrieve population data from the PATHToolsZambia package - this is the population totals at the province level for 2022\npop_northern_2022 <- \n  retrieve(\"province-shp\") %>% \n  st_drop_geometry() %>% \n  filter(geo_province == \"Northern\") %>% \n  pull(census_pop_22) \n\n# Calculate incidence \ndat_sum_inc <- \n  dat_sum %>% \n  # data is from 2022 so rename column for ease of use\n  mutate(pop_22 = pop_northern_2022) %>% \n  # extract year data from the period column \n  mutate(year = year(period)) %>% \n  # scale the population total data for the years that we are missing this data assuming a population growth rate of 2.8% \n  mutate(pop = scale_pop_growth_annual(initial_pop = pop_22, new_year = year, initial_year = 2022, growth_rate = 1.028)) %>% \n  # calculate incidence per 1000 population \n  mutate(monthly_inc_per_1000 = total / pop * 1000)\n```\n:::\n\n\n### Population-Adjusted Plot\n\nWe can view this incidence data both as a timeseries and summarised at the annual level.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Create area plot with population-adjusted data\np1 <- \n  ggplot(dat_sum_inc, aes(x = period, y = monthly_inc_per_1000, fill = nice_names)) + \n  geom_area() +\n  scale_y_continuous(labels = comma) +\n  labs(x = \"Year\", y = \"Malaria cases per 1,000 population per month\") +\n  ggtitle(\"Monthly malaria cases per 1,000 population in Northern Province, Zambia\",\n          subtitle = \"Jan 2018 - June 2024\") +\n  scale_fill_manual(\"Data type\", values = c(\"#A5C4D4\", \"#758ECD\", \"#E3A27F\")) +\n  theme_bw()\n\n# summing data to the yearly level for each data type\ndat_sum_inc_annual <- \n  dat_sum_inc %>% \n  group_by(nice_names, year) %>% \n  summarise(total_inc = sum(monthly_inc_per_1000)) %>% \n  ungroup()\n\n# create a bar chart of annual data \np2 <- \n  ggplot(dat_sum_inc_annual, aes(x = year, y = total_inc, fill = nice_names)) +\n  geom_col() +\n  scale_x_continuous(breaks = 2018:2024) +\n  labs(x = \"Year\", y = \"Annual malaria cases per 1,000 population\") +\n  ggtitle(\"Annual malaria cases per 1,000 \\npopulation in Northern Province, Zambia\",\n          subtitle = \"Jan 2018 - June 2024\") +\n  scale_fill_manual(\"Data type\", values = c(\"#A5C4D4\",\"#758ECD\", \"#E3A27F\")) +\n  theme_bw()\n\n# combine the plots into a single image \np_comb <- ggpubr::ggarrange(p1, p2, common.legend = TRUE, legend = \"bottom\",\n                  widths = c(2,1.2))\n\np_comb\n```\n\n::: {.cell-output-display}\n![](story-telling_files/figure-html/unnamed-chunk-10-1.png){width=4200}\n:::\n:::\n\n\nThe addition of the bar graph makes it easier to see the trends, but would be even easier if we could read off the total incidence on each bar, and it is not necessarily clear to the reader that 2024 only includes 6 months of data. In addition we have cut the title off the plots short with the sizing so lets fix all of that. \n\n\n::: {.cell .column-page}\n\n```{.r .cell-code}\n# calculating bar totals to add to plot - this is the combined total of each of the data_types that year\ndat_sum_inc_annual_tot <- \n  dat_sum_inc_annual %>% \n  group_by(year) %>% \n  summarise(total = sum(total_inc)) %>% #summing total values \n  ungroup() %>% \n  mutate(bar_label = round(total, 0)) %>% #rounding totals to remove decimal places\n  mutate(bar_label = ifelse(year ==  2024, paste0(bar_label, \"*\"), bar_label)) #including * to 2024 label to make a note of months missing\n\n# Plot these changes \np3 <- \n  ggplot(dat_sum_inc_annual, aes(x = year, y = total_inc, fill = nice_names)) +\n  geom_col() +\n  scale_x_continuous(breaks = 2018:2024) +\n  labs(x = \"Year\", y = \"Annual malaria cases per 1,000 population\") +\n  ggtitle(\"Annual malaria cases per 1,000 \\npopulation\",\n          subtitle = \"Jan 2018 - June 2024\") +\n  scale_fill_manual(\"Data type\", values = c(\"#A5C4D4\",\"#758ECD\", \"#E3A27F\")) +\n  theme_bw()\n\n\np4 <- \n  ggplot() +\n  geom_col(data = dat_sum_inc_annual, aes(x = year, y = total_inc, fill = nice_names)) +\n  geom_text(data = dat_sum_inc_annual_tot, aes(x = year, y = total + 25, label = bar_label)) + # include text labels at the top of each bar\n  scale_x_continuous(breaks = 2018:2024) +\n  labs(x = \"Year\", y = \"Annual malaria cases per 1,000 population\", \n       caption = \"* Only includes data up to June 2024\" #include caption note about 2024 missing data\n       ) +\n  ggtitle(\"Annual malaria cases per 1,000 \\npopulation\",\n          subtitle = \"Jan 2018 - June 2024\") +\n  scale_fill_manual(\"Data type\", values = c(\"#A5C4D4\",\"#758ECD\", \"#E3A27F\")) +\n  theme_bw()\n\np_comb2 <- ggpubr::ggarrange(p3, p4, common.legend = TRUE, legend = \"bottom\",\n                            widths = c(2,1.2))\n\n# add a combined figure title \nannotate_figure(p_comb2, top = text_grob(\"Malaria incidence in Northern Province, Zambia\", \n                                        face = \"bold\", size = 14))\n```\n\n::: {.cell-output-display}\n![](story-telling_files/figure-html/unnamed-chunk-11-1.png){width=5400}\n:::\n:::\n\n\nWith this updated figure we can provide clearer key messages to our audience:\n\n-   There was an increase in malaria cases in 2023, to 698 cases per 1,000 population a **32% increase** on 2022\n\n-   Since 2022, there has been an increasing proportion of malaria cases **detected in the community**, potentially contributing to increased case reports\n\n## Exercises\n\nCan you use a similar approach to provide a slide to answer the following question: **Is this increase consistent across all districts, or is it focused in a few places?**\n\n::: callout-tip\n`ggplot` includes an excellent faceting feature (`facet_wrap` and `facet_grid`) that you might find useful to answer this question.\n\n`retrieve(\"district-shp\")` will be useful when retrieving the population data at the district level.\n:::\n\n",
    "supporting": [
      "story-telling_files\\figure-html"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}